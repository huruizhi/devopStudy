## 前后端分离

[TOC]

### restfull api

- 协议 http https
- 域名 api 专用域名
- 版本
- HTTP 动词  get post delete put patch 
- 过滤信息 参数
- 状态码
  - 200 /201 /202 /204
  - 400 /401/ 403/ 404 /406 /410 /422
  - 500
- 错误处理
- 返回结果
- Hypermedia API



## restframework

#### 安装 

```
pip install djangorestframework
```

```
INSTALLED_APPS = [
		...,
    'rest_framework'
]
```

#### 序列化模型

1. 创建 serializers.py文件

```python
from rest_framework import serializers


class IdcSerializer(serializers.Serializer):
    """
    Idc 序列化类
    """
    id = serializers.IntegerField()
    name = serializers.CharField()
    address = serializers.CharField()
    phone = serializers.CharField()
    email = serializers.EmailField()
    letter = serializers.CharField()
```

2. 使用序列化

```python
from idc.models import Idc
from idc.serializers import IdcSerializer
idc = Idc.objects.get(pk = 1)
idc_se = IdcSerializer(idc)

from rest_framework.renderers import JSONRenderer
jr = JSONRenderer()
content = jr.render(idc_se.data)

```

3. 多条记录

```
serialize = IdcSerializer(Idc.objects.all(), many=True)

```



### 反序列化

##### 序列化类 数据合法性 定义create 函数

```python
from rest_framework import serializers
from .models import Idc


class IdcSerializer(serializers.Serializer):
    """
    Idc 序列化类
    """
    id = serializers.IntegerField(read_only=True)
    name = serializers.CharField(required=True, max_length=32)
    address = serializers.CharField(required=True, max_length=256)
    phone = serializers.CharField(required=True, max_length=15)
    email = serializers.EmailField(required=True, max_length=50)
    letter = serializers.CharField(required=True, max_length=5)
    
    def create(self, validated_data):
        return Idc.objects.create(**validated_data)
      
    def update(self, instance, validated_data):
        instance.name = validated_data.get("name", instance.name)
        instance.address = validated_data.get("address", instance.name)
        instance.phone = validated_data.get("phone", instance.name)
        instance.email = validated_data.get("email", instance.name)
        instance.save()
        return instance
```

##### 反序列化

```python
from django.utils.six import BytesIO
from rest_framework.parsers import JSONParser

## content 前端传入的byte 型字符串 

stream = BytesIO(content)
data = JSONParser().parse(stream)

serialize1 = IdcSerializer(data=data)

# 验证数据合法性
serialize1.is_valid()
# 保存数据
serialize1.save()
# 合法数据
serialize1.validated_data
```

##### api_view 与 Response
```
from .models import Idc
from rest_framework.decorators import api_view
from rest_framework import status
from rest_framework.response import Response
from .serializers import IdcSerializer


@api_view(["GET", "POST"])
def idc_list(request, *args, **kwargs):
    if request.method == "GET":
        print(request.path)
        queryset = Idc.objects.all()
        serializer = IdcSerializer(queryset, many=True)
        return Response(serializer.data)
    if request.method == "POST":
        serializer = IdcSerializer(data=request.data)
        if serializer.is_valid():
            serializer.save()
            return Response(status=status.HTTP_201_CREATED)
        return Response(status=status.HTTP_400_BAD_REQUEST)


@api_view(["GET", "PUT"])
def idc_detail(request, pk, *args, **kwargs):
    try:
        queryset = Idc.objects.get(pk=pk)
    except:
        return Response(status=status.HTTP_404_NOT_FOUND)

    if request.method == "GET":
        serializer = IdcSerializer(queryset)
        return Response(serializer.data)
    if request.method == "PUT":
        serializer = IdcSerializer(queryset, data=request.data)

        if serializer.is_valid():
            serializer.save()
            return Response(status=status.HTTP_202_ACCEPTED)
        return Response(status=status.HTTP_400_BAD_REQUEST)
```

简化view 方法

##### APIView
```
from rest_framework.views import APIView
from django.http import Http404


class IdcList(APIView):
    def get(self, request, format=None):
        queryset = Idc.objects.all()
        serializer = IdcSerializer(queryset, many=True)
        return Response(serializer.data)

    def post(self, request, format=None):
        serializer = IdcSerializer(data=request.data)
        if serializer.is_valid():
            serializer.save()
            return Response(serializer.data, status=status.HTTP_201_CREATED)
        return Response(serializer.data, status=status.HTTP_400_BAD_REQUEST)


class IdcDetail(APIView):

    def get_obj(self, pk):
        try:
            Idc_obj = Idc.objects.get(pk=pk)
            return Idc_obj
        except Idc.DoesNotExist:
            raise Http404

    def get(self, request, pk, format=None):
        queryset = self.get_obj(pk)
        serializer = IdcSerializer(queryset)
        return Response(serializer.data)

    def post(self, request, pk, format=None):

        queryset = self.get_obj(pk)
        serializer = IdcSerializer(queryset, data=request.data)

        if serializer.is_valid():
            serializer.save()
            return Response(status=status.HTTP_202_ACCEPTED)
        return Response(status=status.HTTP_400_BAD_REQUEST)

    def delete(self, request, pk, format=None):
        queryset = self.get_obj(pk)
        queryset.delete()
        return Response(status.HTTP_204_NO_CONTENT)
```
##### 使用混合
```
# ################ 版本6 ################


from rest_framework import viewsets


class IdcListV6(viewsets.GenericViewSet,
                mixins.RetrieveModelMixin,
                mixins.UpdateModelMixin,
                mixins.DestroyModelMixin,
                mixins.ListModelMixin,
                mixins.CreateModelMixin
                ):
    queryset = Idc.objects.all()
    serializer_class = IdcSerializer


# ################ 版本7 ################


from rest_framework import viewsets


class IdcViewSetV7(viewsets.ModelViewSet):
    queryset = Idc.objects.all()
    serializer_class = IdcSerializer
```

##### 接口反射
```
from rest_framework.routers import DefaultRouter

route = DefaultRouter()
route.register("idcs", views.IdcViewSetV7)
urlpatterns = [
    url(r'^', include(route.urls))
]
```


##### 总结
数据源 ==> 序列化（定义数据的增删改操作）==> 框架实现restful 风格